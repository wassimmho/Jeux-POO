using System;

namespace Game
{
    public class GamePlay
    {
        // Méthode pour choisir un adversaire aléatoire parmi les vivants
        private static Personnage ChoisirAdversaireRandom(Personnage attaquant, Personnage joueur, Personnage bot1, Personnage bot2)
        {
            Random random = new Random();
            Personnage[] adversaires;

            // Choisir les adversaires en fonction de l'attaquant
            if (attaquant == bot1)
            {
                adversaires = new Personnage[] { joueur, bot2 }; // Si bot1 attaque, il choisit entre le joueur et bot2
            }
            else if (attaquant == bot2)
            {
                adversaires = new Personnage[] { joueur, bot1 }; // Si bot2 attaque, il choisit entre le joueur et bot1
            }
            else
            {
                return null; // Si l'attaquant n'est pas valide, retourner null.
            }

            // Sélectionner un adversaire aléatoire parmi les vivants
            Personnage cible = adversaires[random.Next(adversaires.Length)];
            return cible.EstVivant() ? cible : null; // Retourner null si la cible n'est pas vivante
        }

        public static void Main(string[] args)
        {
            Random random = new Random();

            // Création des personnages
            Personnage guerrier = new Guerrier("Thor");
            Personnage mage = new Mage("Floki");
            Personnage voleur = new Voleur("Loki");

            Personnage joueur = null;
            Personnage bot1 = null;
            Personnage bot2 = null;

            // Demande du choix du personnage
            while (true)
            {
                Console.WriteLine("Choose your main character:");
                Console.WriteLine("1. Guerrier");
                Console.WriteLine("2. Mage");
                Console.WriteLine("3. Voleur");

                int choix;
                if (int.TryParse(Console.ReadLine(), out choix))
                {
                    if (choix == 1)
                    {
                        joueur = guerrier;
                        bot1 = mage;
                        bot2 = voleur;
                        break;
                    }
                    else if (choix == 2)
                    {
                        joueur = mage;
                        bot1 = guerrier;
                        bot2 = voleur;
                        break;
                    }
                    else if (choix == 3)
                    {
                        joueur = voleur;
                        bot1 = guerrier;
                        bot2 = mage;
                        break;
                    }
                }

                Console.WriteLine("Invalid choice. Please enter a number between 1 and 3.");
            }

            // Boucle de combat
            while (guerrier.EstVivant() || mage.EstVivant() || voleur.EstVivant())
            {
                Console.WriteLine("\n--- Round: Fight! ---");
                Console.WriteLine("Choose an action:");
                Console.WriteLine("1. Attack an opponent");
                Console.WriteLine("2. Use a special skill");
                Console.WriteLine("3. Remain passive");

                int action;
                if (int.TryParse(Console.ReadLine(), out action))
                {
                    switch (action)
                    {
                        case 1:
                            var cible = ChoisirAdversaireRandom(joueur, joueur, bot1, bot2);
                            if (cible != null)
                            {
                                joueur.Attaquer(cible);
                            }
                            else
                            {
                                Console.WriteLine("The opponent is already dead.");
                            }
                            break;

                        case 2:
                            cible = ChoisirAdversaireRandom(joueur, joueur, bot1, bot2);
                            if (cible != null)
                            {
                                joueur.UtiliserCompetence(cible);
                            }
                            else
                            {
                                Console.WriteLine("The opponent is already dead.");
                            }
                            break;

                        case 3:
                            Console.WriteLine($"{joueur.GetNom()} remains passive.");
                            break;

                        default:
                            Console.WriteLine("Invalid action. You remain passive.");
                            break;
                    }
                }

                // Actions des bots
                if (bot1.EstVivant())
                {
                    var cibleBot1 = ChoisirAdversaireRandom(bot1, joueur, bot1, bot2);
                    if (cibleBot1 != null)
                    {
                        bot1.Attaquer(cibleBot1);
                    }
                }

                if (bot2.EstVivant())
                {
                    var cibleBot2 = ChoisirAdversaireRandom(bot2, joueur, bot1, bot2);
                    if (cibleBot2 != null)
                    {
                        bot2.Attaquer(cibleBot2);
                    }
                }
            }

            Console.WriteLine("Game Over!");
            if (joueur.EstVivant())
            {
                Console.WriteLine("Congratulations, you won the fight!");
            }
            else
            {
                Console.WriteLine("Unfortunately, you lost. Better luck next time.");
            }
        }
    }
}
